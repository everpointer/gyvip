<!--<!DOCTYPE html>-->
<!--<html lang="en">-->
<!--<head>-->
<!--  <meta charset="UTF-8">-->
<!--  <title>验证手机号码</title>-->
<!--  <link rel="stylesheet" href="assets/css/furtive.min.css" type="text/css" />-->
<!--  <link rel="stylesheet" href="assets/css/base.css" type="text/css" />-->
<!--  <script src="assets/js/av-mini.js"></script>-->
<!--</head>-->
<!--<body>-->
  <section class="measure p2">
    <form id="bindForm" action="doBindMember.php?action=bind" method=POST class="my2">
      <input type="text" name="mobile" value="{{mobile}}" disabled class="my1"/>
      <a href="#" class="btn--blue" id="requestSmsCode" class="my2">获取验证码</a>
      <input type="text" name="smsCode" placeholder="输入验证码" class="my2"/>
      <input type="submit" value="绑定" class="btn--blue" />
    </form>
  </section>
  <script type="text/javascript">
    // Todo: limit api requester
    AV.initialize("{{leancloud_app_id}}", "{{leancloud_app_key}}");
    
    document.getElementById('requestSmsCode').onclick = function(e) {
      e.preventDefault();
      if (this.disabled === true) {
        return false;
      }
      countDown(this, this.text);
      AV.Cloud.requestSmsCode('{{mobile}}').then(function(){
        //发送成功
      }, function(err){
        //发送失败
        alert("发送失败");
      });
    };
    
   $("#bindForm").submit(function(e) {
      e.preventDefault();
      
      var mobile = $("input[name='mobile']").val();
      var smsCode = $("input[name='smsCode']").val();
      if (! mobile.match(/(1(([35][0-9])|(47)|[8][01236789]))\d{8}$/) ||
          smsCode == "") {
        return false;
      }
      
      var spinner = new Spinner({color:'#545454', lines: 12}).spin(document.body);
      $("body").addClass("bg--off-white").css("opaticy", 0.6);
      $.ajax({
        type: 'POST',
        url: 'doBindMember.php?action=bind',
        data: $("#bindForm").serialize(),
        success: function() {
          spinner.stop();
          alert("绑定成功");
          window.location = 'showMember.php';
        },
        error: function() {
          spinner.stop();
          alert("验证失败");
        }
      });
    }); 
    
    function countDown(element, content) {
      // disable element
      element.disabled = true;
      // add disabled styling
      element.className = "btn btn--light-gray";
      // seconds count down
      var seconds = 60;
      element.textContent = content + '('  + seconds + ')';
      var intervalId = setInterval(function() {
        if (seconds-- > 0) {
          element.textContent = content + '(' + seconds + ')';
        } else {
          clearInterval(intervalId);
          element.textContent = content;
          element.className = "btn btn--blue";
          element.disabled = false;
        }
      }, 1000);
    }
  </script>
<!--</body>-->
<!--</html>-->
